---
title: "係数が剰余類Z/pZの四元数を累乗していくと単位元になるのなぁぜなぁぜ"
description: 
slug: quaternion_power
date: 2023-09-20T12:08:30+09:00
image: 
categories:
    - 数学
    - 数論
    - 群論
---

## おことわり
数論群論ともに独学素人なので表現方法が間違っているかもしれない。

## 前提知識
- 剰余類の集合$\mathbb{Z}/p\mathbb{Z}$と有限体
- 行列、行列式の性質
- (数論におけるフェルマーの小定理、オイラーの定理)

## これはなに
四元数$w=a+bi+cj+dk \ (a,b,c,d\in(\mathbb{Z}/p\mathbb{Z}))$を累乗していくと、単位元$1$になることを示す。
ただし、$p$は素数で$\mathbb{Z}/p\mathbb{Z}$は剰余類の集合である。厳密には次を示す。

> $$
> w= a+bi+cj+dk \quad (a,b,c,d\in(\mathbb{Z}/p\mathbb{Z}) \land 何かしらの条件) \\\\
> \Rightarrow
> w^k=1 \quad (\exists k \in \mathbb{N})
> $$

なお、「かつ何かしらの条件」というのは、例えば$0$のように成り立たないものを除外するための条件である。詳しい条件がまだ不明なため、こう書いておく。

また、具体的な$k$の値がいくつであるかも示す。**最小**の$k$を求めるわけではないので注意。

## 四元数とは
虚数単位$i$は$i^2=-1$を満たす数であるが、その他に$j,k$を持ってきて、次の式が成り立つようにする。
$$
i^2=j^2=k^2=ijk=-1
$$

上記の式を変形すると、各$i,j,k$同士の掛け算が以下の
表のようになることがわかる。なお、$ij=k,ji=-k$などのように掛け算の順番によって結果が変わる(非可換)であることに注意。

|  | 1 | $i$ | $j$ | $k$ |
| :-: | :-: | :-: | :-: | :-: |
| 1 | 1 | $i$ | $j$ | $k$ |
| $i$ | $i$ | $-1$ | $k$ | $-j$ |
| $j$ | $j$ | $-k$ | $-1$ | $i$ |
| $k$ | $k$ | $j$ | $-i$ | $-1$ |

$a_1+b_1i+c_1j+d_1k$と$a_2+b_2i+c_2j+d_2k$の掛け算(この掛け算の仕方をハミルトン積と呼ぶらしい)は以下のようになる。

$$
a_1a_2-b_1b_2-c_1c_2-d_1d_2 \\\\
+(a_1b_2+b_1a_2+c_1d_2-d_1c_2)i \\\\
+(a_1c_2-b_1d_2+c_1a_2+d_1b_2)j \\\\
+(a_1d_2+b_1c_2-c_1b_2+d_1a_2)k
$$


ハミルトン積の定義から、$w e = e w = w$となる単位元$e$は$e=1$であることがわかる。

## フェルマーの小定理
### 数論での定理
数論の世界には、フェルマーの小定理と呼ばれる定理がある。
> $$
> a^{p-1} \equiv 1 \pmod{p} \quad (pは素数、aとpは互いに素)
> $$

要するに、$a$を$p-1$回掛けて$p$で割ったあまりを取ると$1$に戻ってくるということである。

これは数学的帰納法で証明できる(階乗がでてくるスマートな証明方法もあるが、ちょっとテクニカルなので愚直にできるこちらを採用した)。

### 証明(数論の世界)
両辺に$a$を掛け算した$a^p \equiv a \pmod{p}$を示す。

$a=1$のとき、$1^p \equiv 1 \pmod{p}$は明らかに成り立つ。

$a=k$のとき、$k^p \equiv k \pmod{p}$が成り立つと仮定すると、$a=k+1$のとき、

$$
\begin{align}
(左辺) &\equiv (k+1)^p \\\\
&\equiv \sum_{i=0}^p {}_p \mathrm{C}_i k^i \\\\
&\equiv k^p + {}\_p \mathrm{C}\_1 k^{p-1} + {}\_p \mathrm{C}\_2 k^{p-2} + \cdots + {}\_p \mathrm{C}\_{p-1} k + 1 \\\\
&\equiv k^p + 1 \\\\
&\equiv k + 1 \\\\
\end{align}
$$

途中で二項係数${}\_p\mathrm{C}\_1,{}\_p\mathrm{C}\_2,\cdots,{}\_p\mathrm{C}\_{p-1}$の値が$p$の倍数になることを使った。

よって、数学的帰納法により、$a^p \equiv a \pmod{p}$、つまり$a^{p-1} \equiv 1 \pmod{p}$が成り立つ。


### 群論での定理
さて、上記の定理では普通の数論の世界でしか使えないが、これを群論の世界に拡張する。
群の定義を確認しておく。
> 群とは、集合$G$と二項演算$\circ$の組$(G,\circ)$で、以下の条件を満たすものである。
>
> (G1) 任意の$a,b\in G$に対して、$a\circ b\in G$が成り立つ(閉じている)。 \
> (G2) 任意の$a,b,c\in G$に対して、$(a\circ b)\circ c = a\circ (b\circ c)$が成り立つ(結合律)。\
> (G3) ある$e\in G$が存在して、任意の$a\in G$に対して、$a\circ e = e\circ a = a$が成り立つ(単位元の存在)。\
> (G4) 任意の$a\in G$に対して、ある$b\in G$が存在して、$a\circ b = b\circ a = e$が成り立つ(逆元の存在)。

そして、群論の世界におけるフェルマーの小定理は次のようになる。

> $p$を素数とする。$a$を有限群$G$の元とすると次が成り立つ。
> 
> $$
> g^{|G|} = e
> $$
> ただし、$e$は$G$の単位元で、$|G|$は$G$の位数である。

なお、$g^n$というのは$(G,\circ)$での$g$を$n$回掛け算したものである。また、数論の世界でのフェルマーの小定理は、$G$を$\mathbb{Z}/p\mathbb{Z}$、演算を掛け算とした特殊な場合を指していた。

さて、これも証明をする。

### 証明(群論の世界)
おやくそく
- $G$の位数を$n$とする。
- $g$は$G$の元である。
- $g$の逆元を$g^{-1}$とする。
- $g^k$は$g$を$k$回掛け算したものである。

まず、$g^k=e$となる$k$は必ず存在することを示す。

$G$の元は有限個なので、$g,g^2,g^3,\cdots,g^{n},g^{n+1}$の$n+1$個の計算結果を持ってきたときに、少なくとも$1$組は同じ値になる。[^1]

[^1]: 鳩ノ巣原理による

これにより$g^a=g^b$を満たす$ a>b $が存在するので、両辺に$(g^{-1})^b$を掛けると$g^{a-b}=e$となる。よって、$k=a-b$とすれば$g^k=e$となる$k$が存在することがわかった。

$g,g^2,g^3,\cdots$を延々と列挙していくと、ループすることがわかる。このループの周期を$k$個として、$G$の部分集合$H$

$$
H=\lbrace g,g^2,g^3,\cdots,g^{k-1},g^k \rbrace
$$

を考える。
次のように$H$は群になっていることがわかる。
- $g$のべき乗同士の積も$g$のべき乗になるので、閉じている。
- 結合法則は$G$で成り立つので、当然$H$でも成り立つ。
- $G$での単位元$e$は$H$でも存在($g^k$)する。
- $g^i$の逆元は$g^{k-i}$である。

また、$H$の定義から$H$の位数は$g$の位数$k$と等しい。

さて、$G$を$m$個の集合$H_1,H_2,\cdots,H_m$に分割する。今の段階で、$m$が具体的にどういう数であるかは一旦考えないでおく(有限であることは明らかである)。
分割するというのは、厳密には次のようなことを言っている。
$$
G=H_1 \cup H_2 \cup \cdots \cup H_m \quad \\\\
H_i \cap H_j = \emptyset \quad (i\neq j)
$$
適当に$g_0\in G$を持ってきて、$H_1=\lbrace g_0,g_0^2,g_0^3,\cdots ,g_0^k\rbrace$とすると、$H_2,H_3,\cdots$は$H_1$の各要素をある数$g_i$で掛け算すると得ることができる。
この分割により、$G$の位数は$mk$となる。

これを厳密に示す。

(a). $|H_1|=|H_2|=\cdots=|H_m|=k$であることを示す。

> $|H_1|=k$であることがわかっているので、$H_1$にある数$g_i$を掛け算したときに数字に重複がないことを示せばよい。
> 相異なる2つの要素$h_1,h_2\in H_1$で$g_ih_1 = g_ih_2$となってしまうことはありえない。両辺に$g_i^{-1}$を掛けると$h_1=h_2$となってしまうからである。

(b). $H_i \cap H_j = \emptyset \quad (i\neq j)$であることを示す。

> 対偶の$H_i \cap H_j \neq \emptyset \Rightarrow i=j$を示す。
> 仮定より $g_ih_1 = g_jh_2$となる$h_1,h_2\in H_1$が存在する。\
> (1) 両辺に$h_1^{-1}h$を掛ける ($h$は$H_1$の任意の要素)と、$g_ih = g_jh_2h_1^{-1}h$となる。これは、$H_i$の任意の元が$H_j$の元となる(なぜなら、左辺は$H_i$の任意の元を表すことができ、右辺は$h_2h_1^{-1}h$が$H_1$の元で、$g_j$を掛け算することにより$H_j$の元になるから)ことを意味する。つまり$H_i \subset H_j$を意味する。 \
> (2) 同様に、両辺に$h_2^{-1}h$を掛けると、$g_jh = g_ih_1h_2^{-1}h$となる。これは、$H_j$の任意の元が$H_i$の元となることを意味する。つまり$H_j \subset H_i$を意味する。\
> (1),(2)より、$H_i=H_j$となる。

あとは、任意の$g\in G$が$H_1,H_2,\cdots,H_m$のどれかに含まれるかが気になる。
> $km = |G|$を満たすような$m$で、$m$個作ることができることを示す。これは簡単で、次の手順で簡単に作れる。
> 1. 適当に$g_0\in G$を持ってきて、$H_1=\lbrace g_0,g_0^2,g_0^3,\cdots ,g_0^k\rbrace$とする。
> 2. $H_1$に含まれていない$g_1\in G$を持ってきて、$H_1$の各要素を$g_1$で掛け算したものを$H_2$とする。$H_1$と$H_2$は(b)より互いに素である。
> 3. $H_1,H_2$に含まれていない$g_2\in G$を持ってきて、$H_1,H_2$の各要素を$g_2$で掛け算したものを$H_3$とする。$H_1,H_2,H_3$は(b)より互いに素である。
> ...これを繰り返すことで、$n$個の元を全て使い切ることができる。

以上より、$G$は$H_1,H_2,\cdots,H_m$の集合に分割できることがわかった。

この性質はラグランジュの定理と呼ばれている。
> $G$を群として、$H$を$G$の部分集合とすると、
> $$
> |G| = |H| \times [G:H]
> $$
> が成り立つ。

$[G:H]$はさっきの説明で言うところの$m$にあたる数の表記方法である。

さて、ついにフィナーレである。

$$
\begin{align}
g^{|G|} &= g^{|H| \times [G:H]} \\\\
&= (g^{|H|})^{[G:H]} \\\\
&= e^{[G:H]} \\\\
&= e
\end{align}
$$

途中、$g^{|H|}=g^k=e$を使った。

以上より、$g^{|G|}=e$が成り立つことがわかった。

## 四元数の話に戻る
さて、十分に材料が整ったので、例の四元数$w=a+bi+cj+dk$を$p^4$乗すると単位元になることを考えよう。
まず、先程のフェルマーの小定理(群論)が使えるかどうかを調べる。考えたい四元数の集合を$\mathbb{H}_p$、演算はハミルトン積とする。

群であるかの条件は、(G1)演算が閉じている、(G2)結合律、(G3)単位元の存在、(G4)逆元の存在である。

また、$\mathbb{H}_p$を必要に応じて条件を追加することで、群の条件を満たすように細工していく。

### 群であるかの条件
実は、これは四元数を行列で表すと解決する。

四元数$w=a+bi+cj+dk \in \mathbb{H}_p$を

$$
W = 
\begin{pmatrix}
a & b & c & d \\\\
-b & a & -d & c \\\\
-c & d & a & -b \\\\
-d & -c & b & a
\end{pmatrix}
$$
と表すと、行列の掛け算と四元数の掛け算(ハミルトン積)は対応する。

行列の掛け算は、(G2)結合律を満たし[^2]、(G3)単位元も単位行列として存在する。

[^2]: 結合律は、単純に計算するだけで証明することはできるので、わざわざ行列に表す必要はあまりない。

ただし、(G4)逆元の存在については注意が必要である。正則行列、すなわち行列式の値が$0$でない行列については、逆行列が存在することが知られているが、行列式の値が$0$の行列については、逆行列がない。


すなわち、
$$
\begin{align}
\det W &= a^2+b^2+c^2+d^2 \\\\
&\neq 0 
\end{align}
$$

が条件となる。

よって、$\mathbb{H}_p$を次のように再定義すれば、(G2),(G3),(G4)を満たす。

$$
\mathbb{H}_p = \lbrace a+bi+cj+dk \mid a,b,c,d\in(\mathbb{Z}/p\mathbb{Z}) \land a^2+b^2+c^2+d^2 \neq 0 \rbrace
$$

最後に、(G1)であるが、これも行列式の性質$\det(AB)=\det(A)\det(B)$を使えば、$W_1,W_2\in \mathbb{H}_p$に対して$\det(W_1W_2)=\det(W_1)\det(W_2)\neq 0$となることがわかるので、$W_1W_2\in \mathbb{H}_p$となる。

以上より、$\mathbb{H}_p$は群であることがわかった。

### 位数を求める
定義式をもう一度みる。
$$
\mathbb{H}_p = \lbrace a+bi+cj+dk \mid a,b,c,d\in(\mathbb{Z}/p\mathbb{Z}) \land a^2+b^2+c^2+d^2 \neq 0 \rbrace
$$

$\mathbb{H}_p$の位数は、次の式を満たすような$0$以上$p-1$以下の整数の組$(a,b,c,d)$の個数である。

$$
a^2+b^2+c^2+d^2 \neq 0 \color{red}{\pmod p}
$$

$p^4$通りの組み合わせがあるので、各平方数の和が$p$の倍数になる場合の数を引けばよい。
が、$\mod p$が存在しているせいで、簡単ではなさそうだ。
$a=b=c=d=0$は明らかに満たさないが、他にも満たさない数が存在するかもしれない。

例えば、$p=5$のとき、$a=1,b=2,c=0,d=0$では平方数の和が$5$となってしまう。

ちなみに、ラグランジュの四元数定理というものが存在し、任意の自然数は必ず$4$つの平方数の和として表す方法が$1$通り以上あることが知られている。よって、$a=b=c=d=0$のように自明な場合以外を考える必要が生じていて、これは難しそうである。


$p$が小さければ計算機を使って数え上げることができるので、$p=17$について調べてみた。雑にプログラムを書いてみると、
```python
p = 17

cnt = 0
for a in range(0,p):
    for b in range(0,p):
        for c in range(0,p):
            for d in range(0,p):
                x = a*a+b*b+c*c+d*d
                if x % p != 0:
                    cnt += 1

print(cnt)
```
$78336$が得られる。sagemathで、適当な四元数の$78336$乗を計算すると、
```python
import os
# from Crypto.Util.number import getPrime
p = 17
Q = QuaternionAlgebra(Zmod(p), -1, -1)
i, j, k = Q.gens()

a = 3
b = 14
c = 15
d = 9
x = a + b*i + c*j + d*k
assert (a*a+b*b+c*c+d*d) % p != 0

e = 78336
print(x^e)
```
$1$が得られる。得られることがわかった。

ただ、この$78336$は$p$によって変わるので、$p$が大きくなると計算機では数え上げることができない。

次の節では一般的な行列に考えを拡張して、位数を求めやすくする。

### $4$次正則正方行列の部分集合である
四元数が$4$次の正方行列を用いた表現を再掲する。

$$
W = 
\begin{pmatrix}
a & b & c & d \\\\
-b & a & -d & c \\\\
-c & d & a & -b \\\\
-d & -c & b & a
\end{pmatrix}
$$

先程の$\mathbb{H}_p$を行列の集合に変換した$\mathbb{H}^\prime_p$を定義する。

$$
\mathbb{H}^\prime_p = \left\lbrace
W = 
\begin{pmatrix}
a & b & c & d \\\\
-b & a & -d & c \\\\
-c & d & a & -b \\\\
-d & -c & b & a
\end{pmatrix}
\mid a,b,c,d\in(\mathbb{Z}/p\mathbb{Z}) \land \det W \neq 0 \right\rbrace
$$

また、$4$次の正則で正方行列の集合を$\mathrm{GL}_4(\mathbb{Z}/p\mathbb{Z})$とする。

$$
\mathrm{GL}\_4(\mathbb{Z}/p\mathbb{Z}) = \left\lbrace
A = 4次正方行列
\mid a,b,c,d\in(\mathbb{Z}/p\mathbb{Z}) \land \det A \neq 0 \right\rbrace
$$

このとき、定義より明らかに$\mathbb{H}^\prime_p \subset \mathrm{GL}_4(\mathbb{Z}/p\mathbb{Z})$である。
また、先程の議論より、$\mathrm{GL}_4(\mathbb{Z}/p\mathbb{Z})$は群であり、$\mathbb{H}^\prime_p$は$\mathrm{GL}_4(\mathbb{Z}/p\mathbb{Z})$の部分群である。

つまり、$\mathrm{GL}_4(\mathbb{Z}/p\mathbb{Z})$の位数が分かれば、フェルマーの小定理(群論)より、任意の$A\in \mathrm{GL}_4(\mathbb{Z}/p\mathbb{Z})$に対して、

$$
A^{|\mathrm{GL}_4(\mathbb{Z}/p\mathbb{Z})|} = E
$$

が成り立ち、当然$\mathbb{H}^\prime_p$の元$A$に対しても成り立つ。

問題なのは$\mathrm{GL}_4(\mathbb{Z}/p\mathbb{Z})$の位数を求める = 正則な$4$次正方行列の個数を求めることである。

ここでのポイントは、$\mathbb{H}^\prime_p$の元の中で、正則である行列の個数を求めることは困難であるが、$\mathrm{GL}_4(\mathbb{Z}/p\mathbb{Z})$の元の中で、正則である行列の個数はより数えやすいということである。

### $\mathrm{GL}_4(\mathbb{Z}/p\mathbb{Z})$の位数を求める

行列が正則であることは、各行ベクトルが線形独立であることと同値である。行ベクトルを$A=(a_1,a_2,a_3,a_4)$とすると、

- $a_1$は$p^4$通りの組み合わせがあり、それぞれの場合について、$p$通りの線形従属な$a_2$が存在する。
- よって、$a_1$と$a_2$の組み合わせは$p^4  (p^4-p)$通りある。
- さらに、整数係数で$c_1a_1+c_2a_2$と表される$a_3$は$p^2$通りあるから、$a_1,a_2,a_3$の組み合わせは$p^4(p^4-p)(p^4-p^2)$通りある。
- さらに、整数係数で$c_1a_1+c_2a_2+c_3a_3$と表される$a_4$は$p^3$通りあるから、$a_1,a_2,a_3,a_4$の組み合わせは$p^4(p^4-p)(p^4-p^2)(p^4-p^3)$通りある。

よって、$\mathrm{GL}_4(\mathbb{Z}/p\mathbb{Z})$の位数は、$p^4(p^4-p)(p^4-p^2)(p^4-p^3)$である。

先程の難しい数え上げの問題を解く必要がなくなり、単純な$p$の多項式を計算すれば単位元になることがわかった。
```python
import os
# from Crypto.Util.number import getPrime
p = 17
Q = QuaternionAlgebra(Zmod(p), -1, -1)
i, j, k = Q.gens()

a = 3
b = 14
c = 15
d = 9
x = a + b*i + c*j + d*k
assert (a*a+b*b+c*c+d*d) % p != 0

e = p^4*(p^4-p)*(p^4-p^2)*(p^4-p^3)
print(x^e)
```

お疲れ様でした。




## 参考文献
- [四元数 - Wikipedia](https://ja.wikipedia.org/wiki/%E5%9B%9B%E5%85%83%E6%95%B0)
- [有限体上の正方行列が正則になる確率 - あのあれ](https://note.com/anoare314/n/n70d3c2d062c1)
- [群論におけるフェルマーの小定理 - tsujimotterのノートブック](https://tsujimotter.hatenablog.com/entry/fermat-little-theorem-by-group-theory)

